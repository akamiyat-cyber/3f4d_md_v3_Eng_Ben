<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3F4D Pro Scheduler</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --color-pitan: #c3e6cb; --border-pitan: #28a745; --text-pitan: #155724;
            --color-md: #ffeeba;    --border-md: #e2b709;    --text-md: #856404;
            --color-pi: #fff9db;    --border-pi: #ffe066;    --text-pi: #856404;
            --color-f3d: #b8daff;   --border-f3d: #007bff;   --text-f3d: #004085;
            --color-heading: #d6bcfa; --border-heading: #6b46c1; --text-heading: #322659;
            --color-base: #e2e8f0;    --border-base: #718096;    --text-base: #1a202c;
            --ios-accent: #007aff;
            --color-flood: #007bff;
            --color-drain: #e9ecef;
            --warning-bg: #fff5f5;
            --order-error-bg: #ffe6e6; /* Date order error background */
        }
        body { 
            background-color: #f4f7f6; 
            font-size: 0.85rem; 
            font-family: -apple-system, sans-serif; 
            padding-bottom: 40px;
        }
        
        .header-section { background: #fff; padding: 10px; border-bottom: 1px solid #dee2e6; position: sticky; top: 0; z-index: 1050; }
        .farmer-nav { display: flex; align-items: center; gap: 10px; overflow-x: auto; margin-top: 5px; }
        .farmer-tab { padding: 5px 15px; border-radius: 20px; border: 1px solid #ddd; background: #f8f9fa; white-space: nowrap; cursor: pointer; transition: 0.2s; }
        .farmer-tab.active { background: var(--ios-accent); color: white; border-color: var(--ios-accent); font-weight: bold; }
        .btn-add-farmer { border-radius: 50%; width: 32px; height: 32px; padding: 0; font-weight: bold; flex-shrink: 0; }

        .config-panel { max-height: calc(100vh - 150px); overflow-y: auto; padding: 15px; background: white; border-right: 1px solid #dee2e6; }
        .main-panel { padding: 15px; }
        .card { margin-bottom: 10px; border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { font-weight: bold; background-color: #f8f9fa; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        
        /* Updated Manual Highlight Style: Red Border */
        .manual-highlight { border: 2px solid red !important; outline: none !important; }
        
        .row-pitan, .input-pitan { background-color: var(--color-pitan) !important; border-left: 8px solid var(--border-pitan) !important; }
        .row-md, .input-md { background-color: var(--color-md) !important; border-left: 8px solid var(--border-md) !important; }
        .row-pi, .input-pi { background-color: var(--color-pi) !important; border-left: 8px solid var(--border-pi) !important; }
        .row-f3d, .input-f3d { background-color: var(--color-f3d) !important; border-left: 8px solid var(--border-f3d) !important; }
        .row-heading, .input-heading { background-color: var(--color-heading) !important; border-left: 8px solid var(--border-heading) !important; font-weight: bold; }
        .row-base, .input-base { background-color: var(--color-base) !important; border-left: 8px solid var(--border-base) !important; }

        .date-invalid { background-color: var(--warning-bg) !important; border: 1px solid #dc3545 !important; }
        .row-error { background-color: var(--order-error-bg) !important; }

        .yp-toggle-container { border: 2px solid var(--border-pi); border-radius: 8px; padding: 10px; background-color: #fffdf5; margin: 10px 0; }
        #calendar { background: white; padding: 10px; border-radius: 12px; min-height: 450px; }
        .fc-daygrid-day-number { font-weight: bold; }
        .ben-cal-date { font-size: 0.65rem; color: #d63384; font-weight: normal; margin-top: 1px; display: block; line-height: 1; }
        
        .memo-list-item { border-left: 5px solid #ffc107; background: #fff; padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .memo-img-preview { max-width: 100px; max-height: 100px; display: block; margin-top: 5px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }

        .btn-reset-item { padding: 0 5px; font-size: 10px; line-height: 1.5; margin-left: 5px; }

        /* Indicator Styles */
        .duration-bar { display: flex; height: 6px; border-radius: 3px; background: #eee; margin-top: 4px; overflow: hidden; width: 60px; }
        .bar-flood { background-color: var(--color-flood); height: 100%; }
        .bar-drain { background-color: #dee2e6; height: 100%; }

        /* Slide View Styles */
        .slide-scroll-area { 
            width: 100%; 
            overflow: auto; 
            border: 1px solid #eee; 
            border-radius: 8px; 
            position: relative;
        }
        .slide-container { 
            position: relative; 
            display: inline-block; 
            margin: 0 auto; 
            transform-origin: top left;
            transition: transform 0.2s ease-out;
        }
        .slide-img { width: 1000px; max-width: none; height: auto; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .date-marker {
            position: absolute;
            transform: translate(-50%, 0);
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 1px 4px;
            font-weight: bold;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-size: clamp(9px, 1.3vw, 14px);
        }

        /* Logic Viewer Table Styles */
        .logic-viewer-table { font-size: 0.7rem; color: #4b5563; }
        .logic-viewer-table th { background-color: #f3f4f6; color: #374151; font-weight: 600; white-space: nowrap; }
        .logic-viewer-table td { border-bottom: 1px solid #f1f5f9; padding: 4px 8px !important; vertical-align: middle; }
        
        .map-controls {
            display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap;
        }
    </style>
</head>
<body>

<div id="offline-badge" class="alert alert-warning py-1 m-0 text-center d-none" style="font-size: 11px; border-radius: 0;">
    Offline Mode: Data saved locally
</div>

<div class="header-section">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold text-primary m-0">
            3F4D+MD Pro
            <span style="font-size: 0.5em; color: #6c757d;">(JICA/JST)</span>
        </h5>
        
        <div class="d-flex gap-2">
            <a href="https://www.accuweather.com/en/bd/bangladesh-weather" target="_blank" class="btn btn-sm btn-outline-info text-decoration-none" title="Weather Forecast">
                тЫЕ Weather
            </a>
            
            <select id="lang-selector" class="form-select form-select-sm" style="width: auto;" onchange="changeLanguage(this.value)">
                <option value="en">English</option>
                <option value="bn">ржмрж╛ржВрж▓рж╛</option>
            </select>

            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    тЪЩя╕П
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><h6 class="dropdown-header">Backup & Export</h6></li>
                    <li><button class="dropdown-item" onclick="exportJSON('all')">ЁЯУе Backup All (Full JSON)</button></li>
                    <li><button class="dropdown-item" onclick="exportJSON('current')">ЁЯУе Export Current (Share JSON)</button></li>
                    <li><button class="dropdown-item" onclick="document.getElementById('importFile').click()">ЁЯУд Import JSON</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item fw-bold text-danger" onclick="exportPDF()">ЁЯУД Export PDF Report</button></li>
                    <li><button class="dropdown-item fw-bold text-primary" onclick="exportCalendarPDF()">ЁЯУЕ Export Calendar PDF (Landscape)</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header text-danger">Advanced</h6></li>
                    <li><button class="dropdown-item text-danger" onclick="confirmResetAll()">тЪая╕П Hard Reset (Clear All)</button></li>
                </ul>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importJSON(this)">
            </div>
        </div>
    </div>
    
    <div class="d-flex flex-column align-items-center mt-2">
        <div class="farmer-nav" id="farmerTabs">
            <button class="btn btn-outline-primary btn-add-farmer" onclick="addNewFarmer()">+</button>
        </div>
        
        <div class="d-flex gap-2 mt-2 flex-wrap justify-content-center">
            <button class="btn btn-sm btn-outline-secondary py-0 px-2 btn-label-rename" onclick="renameFarmer()" style="font-size: 10px;">Rename farmer</button>
            <button class="btn btn-sm btn-outline-danger py-0 px-2 btn-label-delete" onclick="deleteFarmer()" style="font-size: 10px;">Delete farmer</button>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-4 config-panel" id="tour-step-1">
            <div class="card">
                <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseProfile" id="hdr-profile">0. Field Profile</div>
                <div id="collapseProfile" class="collapse show">
                    <div class="card-body row g-2">
                        <div class="col-12">
                            <label class="small fw-bold lbl-name">Farmer Name</label>
                            <input type="text" id="prof_name" class="form-control form-control-sm" onchange="updateProfile()">
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-village">Village Name</label>
                            <input type="text" id="prof_village" class="form-control form-control-sm" onchange="updateProfile()">
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-variety">Rice Variety</label>
                            <input type="text" id="prof_variety" class="form-control form-control-sm" placeholder="e.g. BRRI Dhan 28" onchange="updateProfile()">
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-size">Field Size</label>
                            <div class="input-group input-group-sm">
                                <input type="number" id="prof_size" class="form-control" onchange="updateProfile()">
                                <select id="prof_size_unit" class="form-select" style="max-width: 130px;" onchange="updateProfile()">
                                    </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-coords">GPS Coordinates</label>
                            <div class="input-group input-group-sm">
                                <input type="text" id="prof_coords" class="form-control" readonly placeholder="Lat, Lng">
                                <button class="btn btn-outline-secondary" type="button" onclick="getGPS()" id="btn-gps">ЁЯУН Get GPS</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseOne" id="hdr-settings">1. Basic settings (days)</div>
                <div id="collapseOne" class="collapse">
                    <div class="card-body row g-2">
                        <div class="col-12">
                            <label class="small fw-bold lbl-p_start_off">Pitan start after transplanting</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="p_start_off" class="form-control form-control-sm" value="25">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('p_start_off', 25)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-p_dur">Pitan Duration</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="p_dur" class="form-control form-control-sm" value="4">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('p_dur', 4)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-md_start_off">MD start after sowing seed</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="md_start_off" class="form-control form-control-sm" value="80">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('md_start_off', 80)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-md_dur">MD duration</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="md_dur" class="form-control form-control-sm" value="8">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('md_dur', 8)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-pi_check_off">Panicle Initiation check (day after MD Start)</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="pi_check_off" class="form-control form-control-sm" value="6">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('pi_check_off', 6)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-hd_das">Heading day after sowing</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="hd_das" class="form-control form-control-sm" value="119">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('hd_das', 119)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-pi_off">Flooding during panicle initiation before heading</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="pi_off" class="form-control form-control-sm" value="25">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('pi_off', 25)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-f3d_off">3F4D start before heading</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="f3d_off" class="form-control form-control-sm" value="21">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('f3d_off', 21)">тЖ║</button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold lbl-hv_off">Harvest after heading</label>
                            <div class="d-flex align-items-center">
                                <input type="number" id="hv_off" class="form-control form-control-sm" value="28">
                                <button class="btn btn-link btn-reset-item text-decoration-none" onclick="resetSetting('hv_off', 28)">тЖ║</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="tour-step-2">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#collapseTwo" style="cursor: pointer;" id="hdr-dates">2. Date Settings (Adjustable)</div>
                <div id="collapseTwo" class="collapse show">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <button class="btn btn-xs btn-outline-warning py-0 px-2 btn-label-resetfarmer" onclick="event.stopPropagation(); resetToDefault()" style="font-size: 10px;">Reset Farmer</button>
                        </div>
                        <div id="date_inputs_container"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header collapsed" data-bs-toggle="collapse" data-bs-target="#collapseThree" style="cursor: pointer;" id="hdr-logic">3. Logic Configuration (Formulas)</div>
                <div id="collapseThree" class="collapse">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm logic-viewer-table mb-0">
                                <thead>
                                    <tr>
                                        <th>цЧецЬмшкЮ</th>
                                        <th>English</th>
                                        <th>Bengali</th>
                                        <th>Logic_En</th>
                                        <th>Logic_Ben</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>цТнчиоцЧе</td><td>Sowing</td><td>ржмржкржи</td><td>Setting date</td><td>рждрж╛рж░рж┐ржЦ ржирж┐рж░рзНржзрж╛рж░ржг (цЧеф╗ШшинхоЪ)</td></tr>
                                    <tr><td>чз╗цдНцЧе</td><td>Transplanting</td><td>ржЪрж╛рж░рж╛ рж░рзЛржкржг</td><td>Sowing + 40 days</td><td>ржмржкржи + рзкрзж ржжрж┐ржи</td></tr>
                                    <tr><td>уГФуВ┐уГ│щЦЛхзЛ</td><td>Pitan Start</td><td>ржкрж┐рждрж╛ржи рж╢рзБрж░рзБ</td><td>Transplanting + Pitan start after transplanting</td><td>ржЪрж╛рж░рж╛ рж░рзЛржкржг + ржЪрж╛рж░рж╛ рж░рзЛржкржгрзЗрж░ ржкрж░ ржкрж┐рждрж╛ржи рж╢рзБрж░рзБ</td></tr>
                                    <tr><td>уГФуВ┐уГ│ч╡Вф║Ж</td><td>Pitan End</td><td>ржкрж┐рждрж╛ржи рж╢рзЗрж╖</td><td>Pitan Start + Pitan Duration</td><td>ржкрж┐рждрж╛ржи рж╢рзБрж░рзБ + ржкрж┐рждрж╛ржирзЗрж░ рж╕ржоржпрж╝ржХрж╛рж▓</td></tr>
                                    <tr><td>ф╕нх╣▓уБЧщЦЛхзЛ</td><td>MD Start</td><td>ржПржоржбрж┐ рж╢рзБрж░рзБ</td><td>Sowing + MD End</td><td>ржмржкржи + ржмрзАржЬ ржмржкржирзЗрж░ ржкрж░ ржПржоржбрж┐ рж╢рзБрж░рзБ</td></tr>
                                    <tr><td>х╣╝чйВх╜вцИРчв║шкНщЦЛхзЛ</td><td>Panicle Initiation Check start</td><td>рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржкрж░рзАржХрзНрж╖рж╛ рж╢рзБрж░рзБ</td><td>MD start + Panicle Initiation check (day after MD Start)</td><td>ржПржоржбрж┐ рж╢рзБрж░рзБ + рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржкрж░рзАржХрзНрж╖рж╛ (ржПржоржбрж┐ рж╢рзБрж░рзБрж░ ржкрж░рзЗрж░ ржжрж┐ржи)</td></tr>
                                    <tr><td>ф╕нх╣▓уБЧч╡Вф║Ж</td><td>MD End</td><td>ржПржоржбрж┐ рж╢рзЗрж╖</td><td>MD Start + MD Duration</td><td>ржПржоржбрж┐ рж╢рзБрж░рзБ + ржПржоржбрж┐ рж╕ржоржпрж╝ржХрж╛рж▓</td></tr>
                                    <tr><td>ф╕нх╣▓уБЧх╛МчБМц╝СщЦЛхзЛ</td><td>Flooding start (Panicle initiation)</td><td>ржкрзНрж▓рж╛ржмржи рж╢рзБрж░рзБ (рж╢рзАрж╖ ржЖрж╕рж╛рж░ рж╕ржорзЯ)</td><td>Heading - Flooding during panicle initiation before heading. уБЯуБауБЧуАБManual Young Panicle (1-2mm)уБлхЕехКЫуБМуБВуВМуБ░уБЭуБохАдуВТчФиуБДуВЛуАВ</td><td>рж╢рзАрж╖ ржЖрж╕рж╛ - (рж╢рзАрж╖ ржЖрж╕рж╛рж░ рж╕ржорзЯ ржкрзНрж▓рж╛ржмржи рж╕ржоржпрж╝ржХрж╛рж▓) рждржмрзЗ, ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ржХржЪрж┐ рж╢рзАрж╖ (рзз-рзи ржорж┐ржорж┐) ьЧР ржЗржиржкрзБржЯ ржерж╛ржХрж▓рзЗ рж╕рзЗржЗ ржорж╛ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржмрзЗред</td></tr>
                                    <tr><td>ф╕нх╣▓уБЧцЬАх╛МуБочБМц╝С</td><td>Flooding end</td><td>ржкрзНрж▓рж╛ржмржи рж╢рзЗрж╖</td><td>Flooding Start (Panicle initiation) - (Flooding during panicle initiation before heading  - 3F4D start before heading)</td><td>ржкрзНрж▓рж╛ржмржи рж╢рзБрж░рзБ - (рж╢рзАрж╖ ржЖрж╕рж╛рж░ рж╕ржорзЯ ржкрзНрж▓рж╛ржмржи - рзйржПржлрзкржбрж┐ рж╢рзБрж░рзБ)</td></tr>
                                    <tr><td>3F4DуАА1уВ╡уВдуВпуГлчЫо</td><td>3F4D_1 (Start)</td><td>рзйржПржлрзкржбрж┐_рзз (рж╢рзБрж░рзБ)</td><td>Flooding end</td><td>ржкрзНрж▓рж╛ржмржи рж╢рзЗрж╖</td></tr>
                                    <tr><td>3F4DуАА2уВ╡уВдуВпуГлчЫо</td><td>3F4D_2</td><td>рзйржПржлрзкржбрж┐_рзи</td><td>3F4D_1 (Start) + 7</td><td>рзйржПржлрзкржбрж┐_рзз + рзн ржжрж┐ржи</td></tr>
                                    <tr><td>3F4DуАА3уВ╡уВдуВпуГлчЫо</td><td>3F4D_3</td><td>рзйржПржлрзкржбрж┐_рзй</td><td>3F4D_2 (Start) + 7</td><td>рзйржПржлрзкржбрж┐_я╝Т + рзн ржжрж┐ржи</td></tr>
                                    <tr><td>хЗ║чйВцЧе</td><td>Heading</td><td>рж╢рзАрж╖ ржЖрж╕рж╛</td><td>Heading + Heading day after sowing</td><td>рж╢рзАрж╖ ржЖрж╕рж╛ + ржмрзАржЬ ржмржкржирзЗрж░ ржкрж░ рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржжрж┐ржи</td></tr>
                                    <tr><td>3F4DуАА4уВ╡уВдуВпуГлчЫо</td><td>3F4D_4</td><td>рзйржПржлрзкржбрж┐_рзк</td><td>3F4D_3 (Start) + 7</td><td>рзйржПржлрзкржбрж┐_я╝У +я╝Ч ржжрж┐ржи</td></tr>
                                    <tr><td>3F4DуАА5уВ╡уВдуВпуГлчЫо</td><td>3F4D_5</td><td>рзйржПржлрзкржбрж┐_рзл</td><td>3F4D_4 (Start) + 7</td><td>рзйржПржлрзкржбрж┐_я╝Ф + я╝Ч ржжрж┐ржи</td></tr>
                                    <tr><td>3F4DуАА6уВ╡уВдуВпуГлчЫо</td><td>3F4D_6</td><td>рзйржПржлрзкржбрж┐_рзм</td><td>3F4D_5 (Start) + 7</td><td>рзйржПржлрзкржбрж┐_рзл + я╝Ч ржжрж┐ржи</td></tr>
                                    <tr><td>3F4DуААч╡Вф║Ж</td><td>3F4D End</td><td>рзйржПржлрзкржбрж┐ рж╢рзЗрж╖</td><td>3F4D_6 + 7</td><td>рзйржПржлрзкржбрж┐_рзм + рзн ржжрж┐ржи</td></tr>
                                    <tr><td>цЬАч╡ВчБМц╝С</td><td>Last Irrigation</td><td>рж╢рзЗрж╖ рж╕рзЗржЪ</td><td>3F4D End + 1</td><td>рзйржПржлрзкржбрж┐ рж╢рзЗрж╖ + рзз ржжрж┐ржи</td></tr>
                                    <tr><td>хПОчйл</td><td>Harvesting</td><td>ржлрж╕рж▓ ржХрж╛ржЯрж╛</td><td>Heading + Harvest after heading</td><td>рж╢рзАрж╖ ржЖрж╕рж╛ + рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржкрж░ ржлрж╕рж▓ ржХрж╛ржЯрж╛</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8 main-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <ul class="nav nav-tabs border-0" role="tablist">
                    <li class="nav-item"><button class="nav-link active fw-bold tab-lbl-table" data-bs-toggle="tab" data-bs-target="#tab-table">Table List</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold tab-lbl-cal" id="cal-tab" data-bs-toggle="tab" data-bs-target="#tab-cal">Calendar View</button></li>
                    <li class="nav-item"><button class="nav-link text-dark fw-bold tab-lbl-slide" data-bs-toggle="tab" data-bs-target="#tab-slide">Irrigation Plan Map</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold tab-lbl-graph" data-bs-toggle="tab" data-bs-target="#tab-graph" onclick="renderIrrigationGraph()">Irrigation Time</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold tab-lbl-memos" data-bs-toggle="tab" data-bs-target="#tab-memos">Notes Log</button></li>
                </ul>
                <button class="btn btn-success btn-sm fw-bold shadow-sm btn-label-csv" onclick="exportToExcel()">CSV</button>
            </div>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-table">
                    <div class="card" id="tour-step-3">
                        <table class="table mb-0">
                            <thead>
                                <tr class="small text-muted">
                                    <th class="th-event">Event</th>
                                    <th class="text-end th-date">Date / Indicator</th>
                                    <th class="text-center th-done" style="width: 50px;">Done</th>
                                </tr>
                            </thead>
                            <tbody id="schedule_tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="tab-cal"><div id="calendar"></div></div>
                
                <div class="tab-pane fade" id="tab-memos"><div id="memo_log_container" class="p-1"></div></div>

                <div class="tab-pane fade" id="tab-graph">
                    <div class="card p-3">
                        <h6 class="fw-bold text-secondary mb-3 tab-lbl-graph">Irrigation Time Graph</h6>
                        <div class="d-flex justify-content-end gap-2 mb-2">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Share
                                </button>
                                <ul class="dropdown-menu">
                                    <li><button class="dropdown-item" onclick="exportIrrigationCSV()">CSV</button></li>
                                    <li><button class="dropdown-item" onclick="exportIrrigationPDF()">PDF</button></li>
                                </ul>
                            </div>
                        </div>
                        <canvas id="irrigationChart" style="width:100%; max-height:400px;"></canvas>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-slide">
                    <div class="card p-2 text-center" style="background: #fff; min-height: 400px;" id="tour-step-4">
                        <h6 class="fw-bold text-secondary mb-3">Irrigation Schedule Map</h6>
                        
                        <div class="map-controls">
                            <button class="btn btn-sm btn-outline-secondary" onclick="zoomMap(0.1)">ЁЯФО +</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="zoomMap(-0.1)">ЁЯФО -</button>
                            <button class="btn btn-sm btn-primary" onclick="downloadMap()">Download Map (Image)</button>
                        </div>

                        <div class="slide-scroll-area">
                            <div class="slide-container" id="slide_wrapper">
                                <img src="slide_en_water.png" class="slide-img" alt="Slide Image" onerror="document.getElementById('slide-error').classList.remove('d-none'); this.style.display='none';">
                                <div id="slide_markers"></div>
                            </div>
                        </div>

                        <div id="slide-error" class="alert alert-danger d-none mt-5">
                            <strong>Image not found!</strong><br>
                            Please ensure <code>slide_en_water.png</code> is in the same folder.
                        </div>

                        <div class="mt-3 text-muted" style="font-size: 0.75rem;">
                            *Dates are automatically mapped.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="memoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="memoModalLabel">Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="memoDate">
        <h6 id="memoDateDisplay" class="mb-2 text-primary fw-bold"></h6>
        <textarea id="memoInput" class="form-control mb-3" rows="3" placeholder="Enter note..."></textarea>
        
        <div class="mb-3 border-top pt-2">
            <label class="form-label small fw-bold lbl-irrigation-time">Irrigation Time</label>
            <div class="input-group input-group-sm">
                <input type="number" id="irr_time" class="form-control" placeholder="0">
                <select id="irr_unit" class="form-select" style="max-width: 100px;">
                    <option value="min">Min</option>
                    <option value="hr">Hr</option>
                </select>
            </div>
        </div>

        <div class="mb-3 border-top pt-2">
            <label class="form-label small fw-bold">Add Photo</label>
            <input type="file" id="photoInput" accept="image/*" capture="environment" class="form-control form-control-sm" onchange="previewPhoto(this)">
        </div>
        
        <div id="photoPreviewContainer" class="text-center d-none">
            <img id="photoPreviewImg" class="img-fluid rounded" style="max-height: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div class="mt-2">
                <button class="btn btn-xs btn-outline-danger" onclick="clearPhoto()">Remove Photo</button>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="saveMemo()">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
// --- Service Worker & Config ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Error', err));
    });
}
window.addEventListener('offline', () => document.getElementById('offline-badge').classList.remove('d-none'));
window.addEventListener('online', () => document.getElementById('offline-badge').classList.add('d-none'));

// --- IndexedDB Setup (Dexie.js) ---
const db = new Dexie("3F4D_Database");
db.version(1).stores({
    farmers: "++id, name" 
});

// --- Constants for Default Settings ---
const DEFAULT_SETTINGS = { 
    p_dur: 4, md_dur: 8, pi_check_off: 6, hd_das: 119, pi_off: 25, f3d_off: 21, hv_off: 28,
    p_start_off: 25, md_start_off: 80 
};

// Conversion Rates (Base: ha)
const CONVERSION_RATES = {
    ha: 1,
    a: 0.01,
    bigha: 0.1335,
    decimal: 0.004047
};

// --- Translations ---
const TRANSLATIONS = {
    en: {
        title: "3F4D+MD irrigation scheduler Pro",
        hard_reset: "Hard Reset",
        rename: "Rename farmer",
        delete: "Delete farmer",
        add_farmer: "Add Farmer",
        basic_settings: "1. Basic settings (days)",
        date_settings: "2. Date Settings (Adjustable)",
        logic_config: "3. Logic Configuration (Formulas)",
        reset_farmer: "Reset Farmer",
        // Tabs
        tab_table: "Table List",
        tab_cal: "Calendar View",
        tab_slide: "Irrigation Plan Map",
        tab_memos: "Notes Log",
        tab_graph: "Irrigation Time",
        // Table Headers
        th_event: "Event",
        th_date: "Date / Indicator",
        th_done: "Done",
        // Labels
        sowing: "Sowing *",
        tp: "Transplanting *",
        p_start: "Pitan Start",
        p_end: "Pitan End",
        md_start: "MD Start",
        pi_check_start: "Panicle Init. Check",
        md_end: "MD End",
        pi_flood_start: "Flooding start (PI)",
        pi_flood_end: "Flooding end",
        f3d1: "3F4D_1 (Start)",
        f3d2: "3F4D_2",
        f3d3: "3F4D_3",
        heading: "Heading",
        f3d4: "3F4D_4",
        f3d5: "3F4D_5",
        f3d6: "3F4D_6",
        f3d_end: "3F4D End",
        last_irr: "Last Irrigation",
        harvest: "Harvesting",
        yp_label: "Manual Young Panicle (1-2mm)",
        // Settings Labels
        lbl_p_start_off: "Pitan start after transplanting",
        lbl_p_dur: "Pitan Duration",
        lbl_md_start_off: "MD start after sowing seed",
        lbl_md_dur: "MD duration",
        lbl_pi_check_off: "PI check (day after MD Start)",
        lbl_hd_das: "Heading day after sowing",
        lbl_pi_off: "Flooding during PI before heading",
        lbl_f3d_off: "3F4D start before heading",
        lbl_hv_off: "Harvest after heading",
        // Profile
        lbl_profile: "0. Field Profile",
        lbl_name: "Farmer Name",
        lbl_village: "Village Name",
        lbl_variety: "Rice Variety",
        lbl_size: "Field Size",
        lbl_coords: "GPS Coordinates",
        btn_gps: "ЁЯУН Get GPS",
        lbl_irr_time: "Irrigation Time",
        // Units
        unit_min: "Min",
        unit_hr: "Hr",
        unit_bigha: "Bigha (Bangladesh)",
        // Misc
        offline: "Offline Mode: Data saved locally",
        export_csv: "CSV",
        calc_val: "Calc: ",
        notif_title: "3F4D Reminder",
        notif_msg: "You have events scheduled for tomorrow!",
        btn_export_csv: "Export CSV",
        btn_export_pdf: "Export Graph PDF"
    },
    bn: {
        title: "рзйржПржлрзкржбрж┐ ржкрзНрж░рзЛ рж╕ржоржпрж╝рж╕рзВржЪрзА",
        hard_reset: "рж╣рж╛рж░рзНржб рж░рж┐рж╕рзЗржЯ",
        rename: "ржХрзГрж╖ржХрзЗрж░ ржирж╛ржо ржкрж░рж┐ржмрж░рзНрждржи",
        delete: "ржХрзГрж╖ржХ ржорзБржЫрзБржи",
        add_farmer: "ржирждрзБржи ржХрзГрж╖ржХ",
        basic_settings: "рзз. ржорзМрж▓рж┐ржХ рж╕рзЗржЯрж┐ржВрж╕ (ржжрж┐ржи)",
        date_settings: "рзи. рждрж╛рж░рж┐ржЦ рж╕рзЗржЯрж┐ржВрж╕ (ржкрж░рж┐ржмрж░рзНрждржиржпрзЛржЧрзНржп)",
        logic_config: "рзй. рж▓ржЬрж┐ржХ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи (рж╕рзВрждрзНрж░)",
        reset_farmer: "рж░рж┐рж╕рзЗржЯ",
        // Tabs
        tab_table: "ржЯрзЗржмрж┐рж▓ рждрж╛рж▓рж┐ржХрж╛",
        tab_cal: "ржХрзНржпрж╛рж▓рзЗржирзНржбрж╛рж░",
        tab_slide: "рж╕рзЗржЪ ржкрж░рж┐ржХрж▓рзНржкржирж╛ ржорж╛ржиржЪрж┐рждрзНрж░",
        tab_memos: "ржирзЛржЯ рж▓ржЧ",
        tab_graph: "рж╕рзЗржЪрзЗрж░ рж╕ржоржпрж╝",
        // Table Headers
        th_event: "ржЗржнрзЗржирзНржЯ",
        th_date: "рждрж╛рж░рж┐ржЦ / ржирж┐рж░рзНржжрзЗрж╢ржХ",
        th_done: "рж╕ржорзНржкржирзНржи",
        // Labels
        sowing: "ржмржкржи *",
        tp: "ржЪрж╛рж░рж╛ рж░рзЛржкржг *",
        p_start: "ржкрж┐рждрж╛ржи рж╢рзБрж░рзБ",
        p_end: "ржкрж┐рждрж╛ржи рж╢рзЗрж╖",
        md_start: "ржПржоржбрж┐ рж╢рзБрж░рзБ",
        pi_check_start: "рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржкрж░рзАржХрзНрж╖рж╛ рж╢рзБрж░рзБ",
        md_end: "ржПржоржбрж┐ рж╢рзЗрж╖",
        pi_flood_start: "ржкрзНрж▓рж╛ржмржи рж╢рзБрж░рзБ (рж╢рзАрж╖ ржЖрж╕рж╛рж░ рж╕ржорзЯ)",
        pi_flood_end: "ржкрзНрж▓рж╛ржмржи рж╢рзЗрж╖",
        f3d1: "рзйржПржлрзкржбрж┐_рзз (рж╢рзБрж░рзБ)",
        f3d2: "рзйржПржлрзкржбрж┐_рзи",
        f3d3: "рзйржПржлрзкржбрж┐_рзй",
        heading: "рж╢рзАрж╖ ржЖрж╕рж╛",
        f3d4: "рзйржПржлрзкржбрж┐_рзк",
        f3d5: "рзйржПржлрзкржбрж┐_рзл",
        f3d6: "рзйржПржлрзкржбрж┐_рзм",
        f3d_end: "рзйржПржлрзкржбрж┐ рж╢рзЗрж╖",
        last_irr: "рж╢рзЗрж╖ рж╕рзЗржЪ",
        harvest: "ржлрж╕рж▓ ржХрж╛ржЯрж╛",
        yp_label: "ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ржХржЪрж┐ рж╢рзАрж╖ (рзз-рзи ржорж┐ржорж┐)",
        // Settings Labels
        lbl_p_start_off: "ржЪрж╛рж░рж╛ рж░рзЛржкржгрзЗрж░ ржкрж░ ржкрж┐рждрж╛ржи рж╢рзБрж░рзБ",
        lbl_p_dur: "ржкрж┐рждрж╛ржирзЗрж░ рж╕ржоржпрж╝ржХрж╛рж▓",
        lbl_md_start_off: "ржмрзАржЬ ржмржкржирзЗрж░ ржкрж░ ржПржоржбрж┐ рж╢рзБрж░рзБ",
        lbl_md_dur: "ржПржоржбрж┐ рж╕ржоржпрж╝ржХрж╛рж▓",
        lbl_pi_check_off: "рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржкрж░рзАржХрзНрж╖рж╛ (ржПржоржбрж┐ рж╢рзБрж░рзБрж░ ржкрж░рзЗрж░ ржжрж┐ржи)",
        lbl_hd_das: "ржмрзАржЬ ржмржкржирзЗрж░ ржкрж░ рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржжрж┐ржи",
        lbl_pi_off: "рж╢рзАрж╖ ржЖрж╕рж╛рж░ рж╕ржорзЯ ржкрзНрж▓рж╛ржмржи рж╕ржорзЯржХрж╛рж▓",
        lbl_f3d_off: "рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржЖржЧрзЗ рзйржПржлрзкржбрж┐ рж╢рзБрж░рзБ",
        lbl_hv_off: "рж╢рзАрж╖ ржЖрж╕рж╛рж░ ржкрж░ ржлрж╕рж▓ ржХрж╛ржЯрж╛",
        // Profile
        lbl_profile: "рзж. ржЬржорж┐рж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓",
        lbl_name: "ржХрзГрж╖ржХрзЗрж░ ржирж╛ржо",
        lbl_village: "ржЧрзНрж░рж╛ржорзЗрж░ ржирж╛ржо",
        lbl_variety: "ржзрж╛ржирзЗрж░ ржЬрж╛ржд",
        lbl_size: "ржЬржорж┐рж░ ржЖржпрж╝рждржи",
        lbl_coords: "GPS рж╕рзНржерж╛ржирж╛ржЩрзНржХ",
        btn_gps: "ЁЯУН GPS ржирж┐ржи",
        lbl_irr_time: "рж╕рзЗржЪрзЗрж░ рж╕ржоржпрж╝",
        // Units
        unit_min: "ржорж┐ржирж┐ржЯ",
        unit_hr: "ржШржирзНржЯрж╛",
        unit_bigha: "ржмрж┐ржШрж╛ (ржмрж╛ржВрж▓рж╛ржжрзЗрж╢)",
        // Misc
        offline: "ржЕржлрж▓рж╛ржЗржи ржорзЛржб: ржбрзЗржЯрж╛ рж╕рзНржерж╛ржирзАржпрж╝ржнрж╛ржмрзЗ рж╕ржВрж░ржХрзНрж╖рж┐ржд",
        export_csv: "CSV",
        calc_val: "ржЧржгржирж╛: ",
        notif_title: "рзйржПржлрзкржбрж┐ рж░рж┐ржорж╛ржЗржирзНржбрж╛рж░",
        notif_msg: "ржЖржЧрж╛ржорзАржХрж╛рж▓ ржЖржкржирж╛рж░ ржХрж┐ржЫрзБ ржХрж╛ржЬ ржЖржЫрзЗ!",
        btn_export_csv: "CSV ржПржХрзНрж╕ржкрзЛрж░рзНржЯ",
        btn_export_pdf: "ржЧрзНрж░рж╛ржл PDF ржПржХрзНрж╕ржкрзЛрж░рзНржЯ"
    }
};

let currentLang = localStorage.getItem('f3d_lang') || 'en';

function t(key) {
    return TRANSLATIONS[currentLang][key] || key;
}

function changeLanguage(lang) {
    const sizeInput = document.getElementById('prof_size');
    const unitInput = document.getElementById('prof_size_unit');
    let currentVal = parseFloat(sizeInput.value);
    let currentUnit = unitInput.value;
    
    currentLang = lang;
    localStorage.setItem('f3d_lang', lang);
    document.getElementById('lang-selector').value = lang;
    
    if (!isNaN(currentVal)) {
        let valInHa = currentVal;
        if (currentUnit === 'a') valInHa = currentVal * CONVERSION_RATES.a;
        else if (currentUnit === 'bigha') valInHa = currentVal * CONVERSION_RATES.bigha;
        else if (currentUnit === 'decimal') valInHa = currentVal * CONVERSION_RATES.decimal;
        
        let targetUnit = lang === 'bn' ? 'bigha' : 'ha';
        let newVal = valInHa;
        if (targetUnit === 'bigha') newVal = valInHa / CONVERSION_RATES.bigha;
        
        if(farmers[activeIdx]) {
            farmers[activeIdx].fieldSize = parseFloat(newVal.toFixed(2));
            farmers[activeIdx].fieldSizeUnit = targetUnit;
        }
    }

    const staticIds = {
        'hdr-settings': 'basic_settings', 'hdr-dates': 'date_settings', 'hdr-logic': 'logic_config',
        'hdr-profile': 'lbl_profile', 'btn-gps': 'btn_gps'
    };
    for(const [id, key] of Object.entries(staticIds)) {
        const el = document.getElementById(id);
        if(el) el.innerText = t(key);
    }
    
    document.querySelector('.tab-lbl-table').innerText = t('tab_table');
    document.querySelector('.tab-lbl-cal').innerText = t('tab_cal');
    document.querySelector('.tab-lbl-slide').innerText = t('tab_slide');
    document.querySelector('.tab-lbl-memos').innerText = t('tab_memos');
    document.querySelector('.tab-lbl-graph').innerText = t('tab_graph');
    document.querySelector('.lbl-irrigation-time').innerText = t('lbl_irr_time');

    document.querySelector('.th-event').innerText = t('th_event');
    document.querySelector('.th-date').innerText = t('th_date');
    document.querySelector('.th-done').innerText = t('th_done');

    document.querySelector('.btn-label-rename').innerText = t('rename');
    document.querySelector('.btn-label-delete').innerText = t('delete');
    document.querySelector('.btn-label-resetfarmer').innerText = t('reset_farmer');
    document.querySelector('.btn-label-csv').innerText = t('export_csv');

    document.querySelector('.lbl-name').innerText = t('lbl_name');
    document.querySelector('.lbl-village').innerText = t('lbl_village');
    document.querySelector('.lbl-variety').innerText = t('lbl_variety');
    document.querySelector('.lbl-size').innerText = t('lbl_size');
    document.querySelector('.lbl-coords').innerText = t('lbl_coords');

    const unitSel = document.getElementById('irr_unit');
    unitSel.options[0].text = t('unit_min');
    unitSel.options[1].text = t('unit_hr');

    const settingMap = {
        'lbl-p_start_off': 'lbl_p_start_off', 'lbl-p_dur': 'lbl_p_dur', 
        'lbl-md_start_off': 'lbl_md_start_off', 'lbl-md_dur': 'lbl_md_dur',
        'lbl-pi_check_off': 'lbl_pi_check_off', 'lbl-hd_das': 'lbl_hd_das',
        'lbl-pi_off': 'lbl_pi_off', 'lbl-f3d_off': 'lbl_f3d_off', 'lbl-hv_off': 'lbl_hv_off'
    };
    for (const [cls, key] of Object.entries(settingMap)) {
        const el = document.querySelector('.' + cls);
        if(el) el.innerText = t(key);
    }

    updateSizeUnitOptions();
    initInputs(); 
    loadActiveFarmer(); 
}

function updateSizeUnitOptions() {
    const sel = document.getElementById('prof_size_unit');
    const f = farmers[activeIdx];
    const currentVal = f ? f.fieldSizeUnit : 'ha';
    
    sel.innerHTML = "";
    if (currentLang === 'en') {
        sel.add(new Option('ha', 'ha'));
        sel.add(new Option('a', 'a'));
        sel.add(new Option('Bigha', 'bigha'));
        sel.add(new Option('Decimal', 'decimal'));
    } else {
        sel.add(new Option(t('unit_bigha'), 'bigha'));
    }
    
    if(Array.from(sel.options).some(opt => opt.value === currentVal)) {
        sel.value = currentVal;
    } else {
        sel.value = currentLang === 'en' ? 'ha' : 'bigha';
    }
}

let farmers = []; 
let activeIdx = 0;
let calendar;
let memoModal;
let tempPhotoData = null;
let irrigationChart = null;

const dateKeys = [
    { id: 'sowing', type: 'base' },
    { id: 'tp', type: 'base' },
    { id: 'p_start', type: 'pitan' },
    { id: 'p_end', type: 'pitan' },
    { id: 'md_start', type: 'md' },
    { id: 'pi_check_start', type: 'md' },
    { id: 'md_end', type: 'md' },
    { id: 'pi_flood_start', type: 'pi' },
    { id: 'pi_flood_end', type: 'pi' },
    { id: 'f3d1', type: 'f3d' },
    { id: 'f3d2', type: 'f3d' },
    { id: 'f3d3', type: 'f3d' },
    { id: 'heading', type: 'heading' },
    { id: 'f3d4', type: 'f3d' },
    { id: 'f3d5', type: 'f3d' },
    { id: 'f3d6', type: 'f3d' },
    { id: 'f3d_end', type: 'f3d' },
    { id: 'last_irr', type: 'base' },
    { id: 'harvest', type: 'base' }
];

const slideConfig = [
    { id: 'md_start', left: 9, top: 62 },   
    { id: 'md_end',   left: 16, top: 62 },  
    { id: 'f3d1',     left: 21, top: 91 },  
    { id: 'f3d2',     left: 30, top: 91 },  
    { id: 'f3d3',     left: 44, top: 91 },  
    { id: 'f3d4',     left: 54, top: 91 },  
    { id: 'f3d5',     left: 68, top: 91 },  
    { id: 'f3d6',     left: 80, top: 91 },  
    { id: 'f3d_end',  left: 93, top: 91 },  
    { id: 'harvest',  left: 96, top: 69 }   
];

async function initApp() {
    try {
        const lsData = localStorage.getItem('f3d_pro_final_v2');
        const dbCount = await db.farmers.count();
        if (lsData && dbCount === 0) {
            const parsed = JSON.parse(lsData);
            await db.farmers.bulkPut(parsed);
        }
        farmers = await db.farmers.toArray();
        if (farmers.length === 0) {
            farmers = [{
                id: Date.now(), name: "Farmer 1", village: "", 
                settings: { ...DEFAULT_SETTINGS },
                dates: {}, manualKeys: [], use_yp: false, memos: {}, photos: {}, completed: [], autoDates: {},
                variety: "", fieldSize: "", fieldSizeUnit: "ha", coordinates: "", irrigation: {}
            }];
            await db.farmers.put(farmers[0]);
        }
        activeIdx = 0;
        renderFarmerTabs();
        loadActiveFarmer();
        checkNotifications(); 
    } catch (e) {
        console.error("DB Error:", e);
        alert("Database Error. Please reload.");
    }
}

async function saveToLocal() { 
    if(farmers[activeIdx]) {
        await db.farmers.put(farmers[activeIdx]);
    }
}

function initInputs() {
    const container = document.getElementById('date_inputs_container');
    container.innerHTML = "";
    dateKeys.forEach(k => {
        container.innerHTML += `<div class="mb-2"><label class="small fw-bold mb-1">${t(k.id)} <span id="lock_icon_${k.id}" class="text-danger d-none">ЁЯФТ</span></label><div class="d-flex align-items-center gap-2"><input type="date" id="date_${k.id}" class="form-control form-control-sm input-${k.type}" onchange="updateFromManual('${k.id}')"><small id="ben_date_${k.id}" class="text-muted" style="font-size: 0.75rem; white-space: nowrap;"></small></div></div>`;
        if (k.id === 'md_end') container.innerHTML += `<div class="yp-toggle-container"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="use_yp" onchange="toggleYP()"><label class="form-check-label small fw-bold" for="use_yp">${t('yp_label')} <span id="lock_icon_yp" class="text-danger d-none">ЁЯФТ</span></label></div><div class="d-flex align-items-center gap-2"><input type="date" id="date_yp" class="form-control form-control-sm" disabled onchange="updateFromManual('yp')"><small id="ben_date_yp" class="text-muted" style="font-size: 0.75rem; white-space: nowrap;"></small></div></div>`;
    });
}

function loadActiveFarmer() {
    if(!farmers[activeIdx]) return;
    const f = farmers[activeIdx];
    if(!f.completed) f.completed = [];
    if(!f.memos) f.memos = {};
    if(!f.photos) f.photos = {};
    if(!f.autoDates) f.autoDates = {};
    if(!f.irrigation) f.irrigation = {};

    document.getElementById('prof_name').value = f.name;
    document.getElementById('prof_village').value = f.village || "";
    document.getElementById('prof_variety').value = f.variety || "";
    document.getElementById('prof_size').value = f.fieldSize || "";
    updateSizeUnitOptions(); 
    if(f.fieldSizeUnit) document.getElementById('prof_size_unit').value = f.fieldSizeUnit;
    document.getElementById('prof_coords').value = f.coordinates || "";

    ['p_dur','md_dur','pi_check_off','hd_das','pi_off','f3d_off','hv_off'].forEach(k => document.getElementById(k).value = f.settings[k] || (k === 'pi_check_off' ? 6 : ""));
    document.getElementById('p_start_off').value = f.settings.p_start_off !== undefined ? f.settings.p_start_off : 25;
    document.getElementById('md_start_off').value = f.settings.md_start_off !== undefined ? f.settings.md_start_off : 80;

    document.getElementById('use_yp').checked = f.use_yp;
    document.getElementById('date_yp').disabled = !f.use_yp;
    dateKeys.forEach(k => {
        const el = document.getElementById('date_'+k.id);
        el.value = f.dates[k.id] || "";
        f.manualKeys.includes(k.id) ? el.classList.add('manual-highlight') : el.classList.remove('manual-highlight');
    });
    document.getElementById('date_yp').value = f.dates['yp'] || "";
    
    recalculate('all');
    renderIrrigationGraph(); 
    if (calendar) {
        calendar.render(); 
    }
}

function updateProfile() {
    const f = farmers[activeIdx];
    f.name = document.getElementById('prof_name').value;
    f.village = document.getElementById('prof_village').value;
    f.variety = document.getElementById('prof_variety').value;
    f.fieldSize = document.getElementById('prof_size').value;
    f.fieldSizeUnit = document.getElementById('prof_size_unit').value;
    renderFarmerTabs(); 
    saveToLocal();
}

function getGPS() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const coords = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
            document.getElementById('prof_coords').value = coords;
            farmers[activeIdx].coordinates = coords;
            saveToLocal();
            alert("Coordinates updated!");
        }, () => alert("Unable to retrieve location."));
    } else {
        alert("Geolocation not supported.");
    }
}

function getBengaliDate(gregorianDateStr, forceBengali = false) {
    if(!gregorianDateStr) return "";
    const date = new Date(gregorianDateStr);
    const bengaliMonthsEn = ["Boishakh", "Joishtho", "Ashar", "Srabon", "Bhadro", "Ashshin", "Kartik", "Ogrohayon", "Poush", "Magh", "Falgun", "Chaitra"];
    const bengaliMonthsBn = ["ржмрзИрж╢рж╛ржЦ", "ржЬрзНржпрзИрж╖рзНржа", "ржЖрж╖рж╛ржврж╝", "рж╢рзНрж░рж╛ржмржг", "ржнрж╛ржжрзНрж░", "ржЖрж╢рзНржмрж┐ржи", "ржХрж╛рж░рзНрждрж┐ржХ", "ржЕржЧрзНрж░рж╣рж╛ржпрж╝ржг", "ржкрзМрж╖", "ржорж╛ржШ", "ржлрж╛рж▓рзНржЧрзБржи", "ржЪрзИрждрзНрж░"];
    const daysInMonth = [31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 30, 30];
    const year = date.getFullYear();
    const isLeap = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    if(isLeap) daysInMonth[10] = 31;
    let startOfBoishakh = new Date(year, 3, 14);
    if(date < startOfBoishakh) startOfBoishakh = new Date(year - 1, 3, 14);
    const diffTime = date - startOfBoishakh;
    let dayOfYear = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    let currentMonth = 0;
    while(dayOfYear >= daysInMonth[currentMonth]) {
        dayOfYear -= daysInMonth[currentMonth];
        currentMonth++;
    }
    const benDay = dayOfYear + 1;
    if (currentLang === 'bn' || forceBengali) {
        const benMonth = bengaliMonthsBn[currentMonth];
        const benDayStr = benDay.toString().replace(/\d/g, d => "рзжрззрзирзйрзкрзлрзмя╝Чрзорзп"[d]);
        return `${benDayStr} ${benMonth}`;
    } else {
        const benMonth = bengaliMonthsEn[currentMonth];
        return `${benDay} ${benMonth}`;
    }
}

function recalculate(triggerId) {
    if(!farmers[activeIdx]) return;
    const f = farmers[activeIdx];
    document.querySelectorAll('.config-panel input[type="number"]').forEach(el => {
        if(el.id.startsWith('prof_')) return;
        f.settings[el.id] = el.value;
        if (DEFAULT_SETTINGS[el.id] != el.value) el.classList.add('manual-highlight');
        else el.classList.remove('manual-highlight');
    });
    if(!f.autoDates) f.autoDates = {};
    const setV = (id, date) => { 
        if(!isNaN(date)) { 
            const dateStr = formatDateISO(date);
            f.autoDates[id] = dateStr;
            if (!f.manualKeys.includes(id)) { 
                const el = document.getElementById('date_'+id); 
                el.value = dateStr; 
                f.dates[id] = dateStr; 
            }
        } 
    };
    if (!document.getElementById('date_sowing').value) {
        if (document.getElementById('date_heading').value) setV('sowing', addDays(new Date(document.getElementById('date_heading').value), -parseInt(f.settings.hd_das)));
        else if (document.getElementById('date_tp').value) setV('sowing', addDays(new Date(document.getElementById('date_tp').value), -40));
        else if (document.getElementById('date_md_start').value) setV('sowing', addDays(new Date(document.getElementById('date_md_start').value), -parseInt(f.settings.md_start_off)));
    }
    const sowingStr = document.getElementById('date_sowing').value;
    const sowing = sowingStr ? new Date(sowingStr) : null;
    if (sowing) {
        setV('tp', addDays(sowing, 40));
        setV('md_start', addDays(sowing, parseInt(f.settings.md_start_off)));
        setV('heading', addDays(sowing, f.settings.hd_das));
    }
    const tpStr = document.getElementById('date_tp').value;
    if (tpStr) {
        setV('p_start', addDays(new Date(tpStr), parseInt(f.settings.p_start_off)));
        const pStartStr = document.getElementById('date_p_start').value;
        if(pStartStr) setV('p_end', addDays(new Date(pStartStr), f.settings.p_dur));
    }
    const mdStartStr = document.getElementById('date_md_start').value;
    if (mdStartStr) {
        const mdStart = new Date(mdStartStr);
        setV('md_end', addDays(mdStart, f.settings.md_dur));
        setV('pi_check_start', addDays(mdStart, f.settings.pi_check_off || 6));
    }
    const hdStr = document.getElementById('date_heading').value;
    if (hdStr) {
        const hd = new Date(hdStr);
        const piOff = parseInt(f.settings.pi_off);
        const f3dOff = parseInt(f.settings.f3d_off);
        if (f.use_yp && document.getElementById('date_yp').value) setV('pi_flood_start', new Date(document.getElementById('date_yp').value));
        else setV('pi_flood_start', addDays(hd, -piOff));
        const piStartStr = document.getElementById('date_pi_flood_start').value;
        if(piStartStr) setV('pi_flood_end', addDays(new Date(piStartStr), (piOff - f3dOff)));
        const piEndStr = document.getElementById('date_pi_flood_end').value;
        if (piEndStr) setV('f3d1', new Date(piEndStr));
        else setV('f3d1', addDays(hd, -f3dOff));
        for(let i=2; i<=6; i++) {
            const prevStr = document.getElementById(`date_f3d${i-1}`).value;
            if(prevStr) setV(`f3d${i}`, addDays(new Date(prevStr), 7));
        }
        const f3d6Str = document.getElementById('date_f3d6').value;
        if(f3d6Str) {
            setV('f3d_end', addDays(new Date(f3d6Str), 7));
            const f3dEndStr = document.getElementById('date_f3d_end').value;
            if(f3dEndStr) setV('last_irr', addDays(new Date(f3dEndStr), 1));
        }
        setV('harvest', addDays(hd, f.settings.hv_off));
    }
    const sVal = document.getElementById('date_sowing').value;
    const tVal = document.getElementById('date_tp').value;
    const allowOthers = sVal && tVal;
    dateKeys.forEach(k => {
        const benSpan = document.getElementById('ben_date_' + k.id);
        if(benSpan) benSpan.innerText = f.dates[k.id] ? getBengaliDate(f.dates[k.id]) : "";
        const el = document.getElementById('date_'+k.id);
        const lockIcon = document.getElementById('lock_icon_'+k.id);
        if(el) {
            let isDisabled = false;
            if (k.id !== 'sowing' && k.id !== 'tp' && !allowOthers) isDisabled = true;
            if (f.completed && f.completed.includes(k.id)) isDisabled = true;
            el.disabled = isDisabled;
            if (lockIcon) isDisabled ? lockIcon.classList.remove('d-none') : lockIcon.classList.add('d-none');
            if (f.manualKeys.includes(k.id)) el.classList.add('manual-highlight');
            else el.classList.remove('manual-highlight');
        }
    });
    const ypCheck = document.getElementById('use_yp');
    const ypDate = document.getElementById('date_yp');
    const ypLockIcon = document.getElementById('lock_icon_yp');
    if(ypCheck) ypCheck.disabled = !allowOthers || (f.completed && f.completed.includes('yp'));
    if(ypDate) {
        let ypIsDisabled = false;
        if(!allowOthers || (f.completed && f.completed.includes('yp'))) ypIsDisabled = true;
        else ypIsDisabled = !ypCheck.checked;
        ypDate.disabled = ypIsDisabled;
        if (ypLockIcon) {
            const isFullyLocked = !allowOthers || (f.completed && f.completed.includes('yp'));
            isFullyLocked ? ypLockIcon.classList.remove('d-none') : ypLockIcon.classList.add('d-none');
        }
    }
    saveToLocal(); 
    refreshViews();
}

function formatDateISO(d) {
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function refreshViews() {
    if(!farmers[activeIdx]) return;
    const f = farmers[activeIdx];
    const events = [];
    const tbody = document.getElementById('schedule_tbody'); 
    tbody.innerHTML = "";
    const log = document.getElementById('memo_log_container'); 
    log.innerHTML = "";
    const noteDates = new Set([...Object.keys(f.memos || {}), ...Object.keys(f.photos || {}), ...Object.keys(f.irrigation || {})]);
    Array.from(noteDates).sort().reverse().forEach(date => {
        const hasMemo = f.memos && f.memos[date];
        const hasPhoto = f.photos && f.photos[date];
        const irr = f.irrigation && f.irrigation[date];
        if(hasMemo) events.push({ title: "ЁЯУЭ", start: date, color: '#ffc107', textColor: '#000' });
        if(hasPhoto) events.push({ title: "ЁЯУ╖", start: date, color: '#17a2b8', textColor: '#fff' });
        if(irr) events.push({ title: `ЁЯТз ${irr.value}${irr.unit}`, start: date, color: '#0dcaf0', textColor: '#000' });
        let content = `<div class="memo-list-item"><strong>${date}:</strong><br>`;
        if(irr) content += `<span class="badge bg-info text-dark">Irrigation: ${irr.value} ${irr.unit}</span><br>`;
        if(hasMemo) content += `<span>${f.memos[date]}</span><br>`;
        if(hasPhoto) content += `<img src="${f.photos[date]}" class="memo-img-preview" onclick="openPhotoModal('${date}')">`;
        content += `</div>`;
        log.innerHTML += content;
    });
    if (f.dates['p_start'] && f.dates['p_end']) {
        events.push({ start: f.dates['p_start'], end: formatDateISO(addDays(new Date(f.dates['p_end']), 1)), display: 'background', color: '#c3e6cb' });
    }
    if (f.dates['md_start'] && f.dates['md_end']) {
        events.push({ start: f.dates['md_start'], end: formatDateISO(addDays(new Date(f.dates['md_end']), 1)), display: 'background', color: '#ffeeba' });
    }
    if(f.use_yp && f.dates['yp']) {
        events.push({ title: "YP Check", start: f.dates['yp'], color: '#333' });
        const benDate = getBengaliDate(f.dates['yp']);
        const isDone = f.completed && f.completed.includes('yp');
        tbody.innerHTML += `<tr class="row-base"><td>${t('yp_label')}</td><td class="fw-bold text-end">${f.dates['yp']}<br><small class="text-secondary" style="font-size:0.75em;">${benDate}</small></td><td class="text-center"><input type="checkbox" class="form-check-input" ${isDone ? 'checked' : ''} onchange="toggleComplete('yp')"></td></tr>`;
    }
    let prevDateStr = null;
    dateKeys.forEach(k => {
        const val = f.dates[k.id];
        if(val) {
            const benDate = getBengaliDate(val);
            events.push({ title: `${t(k.id)} (${benDate})`, start: val, allDay: true, color: { pitan:'#28a745', md:'#e2b709', pi:'#ffe066', f3d:'#007bff', heading:'#6b46c1', base:'#718096' }[k.type] });
            if (k.id.startsWith('f3d') && k.id !== 'f3d_end') {
                events.push({ title: `3F4D Flood`, start: val, end: formatDateISO(addDays(new Date(val), 3)), color: '#0056b3', allDay: true });
                events.push({ title: `3F4D Drain`, start: formatDateISO(addDays(new Date(val), 3)), end: formatDateISO(addDays(new Date(val), 7)), color: '#adb5bd', allDay: true });
            }
            let rowClass = `row-${k.type}`;
            let warningText = "";
            if (prevDateStr && val < prevDateStr) { rowClass += " row-error"; warningText = ` <span class="badge bg-danger">! Order</span>`; }
            prevDateStr = val;
            const isDone = f.completed && f.completed.includes(k.id);
            let calcInfo = "";
            if (f.autoDates && f.autoDates[k.id] && f.autoDates[k.id] !== val) {
                const benCalcDate = getBengaliDate(f.autoDates[k.id]);
                calcInfo = `<br><span class="text-muted" style="font-size: 0.7em;">${t('calc_val')} ${f.autoDates[k.id]} (${benCalcDate})</span>`;
            }
            tbody.innerHTML += `<tr class="${rowClass}"><td>${t(k.id)}${warningText}</td><td class="fw-bold text-end">${val}<br><small class="text-secondary" style="font-size:0.75em;">${benDate}</small>${calcInfo}</td><td class="text-center"><input type="checkbox" class="form-check-input" ${isDone ? 'checked' : ''} onchange="toggleComplete('${k.id}')"></td></tr>`;
        }
    });
    if(calendar) { calendar.removeAllEvents(); calendar.addEventSource(events); }
    const slideMarkers = document.getElementById('slide_markers');
    slideMarkers.innerHTML = '';
    slideConfig.forEach(item => {
        const dateVal = f.dates[item.id];
        if(dateVal) {
            const dObj = new Date(dateVal);
            const dateStr = `${dObj.getMonth()+1}/${dObj.getDate()}`;
            const badge = document.createElement('div');
            badge.className = 'date-marker';
            badge.style.left = item.left + '%';
            badge.style.top = item.top + '%';
            badge.innerText = dateStr;
            slideMarkers.appendChild(badge);
        }
    });
}

function addDays(d, n) { const res = new Date(d); res.setDate(res.getDate() + parseInt(n)); return res; }
function resetSetting(id, defaultVal) { document.getElementById(id).value = defaultVal; recalculate('all'); }

function handleDateClick(info) {
    const f = farmers[activeIdx];
    const date = info.dateStr;
    document.getElementById('memoDate').value = date;
    document.getElementById('memoDateDisplay').innerText = date;
    document.getElementById('memoInput').value = (f.memos && f.memos[date]) ? f.memos[date] : "";
    if (f.irrigation && f.irrigation[date]) { document.getElementById('irr_time').value = f.irrigation[date].value; document.getElementById('irr_unit').value = f.irrigation[date].unit; }
    else { document.getElementById('irr_time').value = ""; document.getElementById('irr_unit').value = "min"; }
    clearPhotoUI();
    document.getElementById('photoInput').value = "";
    tempPhotoData = null;
    if(f.photos && f.photos[date]) { tempPhotoData = f.photos[date]; showPreview(tempPhotoData); } 
    memoModal.show();
}

function previewPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; 
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                tempPhotoData = canvas.toDataURL('image/jpeg', 0.6); 
                showPreview(tempPhotoData);
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function showPreview(dataUrl) {
    document.getElementById('photoPreviewImg').src = dataUrl;
    document.getElementById('photoPreviewContainer').classList.remove('d-none');
}

function clearPhoto() {
    tempPhotoData = null;
    document.getElementById('photoInput').value = "";
    clearPhotoUI();
}

function clearPhotoUI() {
    document.getElementById('photoPreviewImg').src = "";
    document.getElementById('photoPreviewContainer').classList.add('d-none');
}

function saveMemo() {
    const f = farmers[activeIdx];
    const date = document.getElementById('memoDate').value;
    const text = document.getElementById('memoInput').value;
    const irrVal = document.getElementById('irr_time').value;
    const irrUnit = document.getElementById('irr_unit').value;
    if(!f.memos) f.memos = {};
    if(!f.photos) f.photos = {};
    if(!f.irrigation) f.irrigation = {};
    if (text === "") delete f.memos[date]; else f.memos[date] = text;
    if (tempPhotoData) f.photos[date] = tempPhotoData; else delete f.photos[date];
    if (irrVal && irrVal > 0) { f.irrigation[date] = { value: parseFloat(irrVal), unit: irrUnit }; } else { delete f.irrigation[date]; }
    saveToLocal();
    refreshViews();
    memoModal.hide();
}

function openPhotoModal(date) {
    const f = farmers[activeIdx];
    if(f.photos && f.photos[date]) handleDateClick({ dateStr: date });
}

function updateFromManual(id) {
    const el = document.getElementById('date_'+id);
    if (!farmers[activeIdx].manualKeys.includes(id)) farmers[activeIdx].manualKeys.push(id);
    farmers[activeIdx].dates[id] = el.value;
    saveToLocal(); recalculate(id);
}

function addNewFarmer() {
    const name = prompt("Enter Farmer/Field Name:");
    if (name) { 
        const newFarmer = { 
            id: Date.now(), name, village: "", 
            settings: { ...DEFAULT_SETTINGS }, 
            dates: {}, manualKeys: [], use_yp: false, memos: {}, photos: {}, completed: [], autoDates: {},
            variety: "", fieldSize: "", fieldSizeUnit: "ha", coordinates: "", irrigation: {}
        };
        farmers.push(newFarmer); 
        db.farmers.put(newFarmer); 
        activeIdx = farmers.length-1; 
        renderFarmerTabs(); 
        loadActiveFarmer(); 
    }
}

function renderFarmerTabs() {
    const container = document.getElementById('farmerTabs');
    container.innerHTML = `<button class="btn btn-outline-primary btn-add-farmer" onclick="addNewFarmer()">+</button>`;
    farmers.forEach((f, idx) => {
        const btn = document.createElement('div');
        btn.className = `farmer-tab ${idx === activeIdx ? 'active' : ''}`;
        btn.innerText = f.name;
        btn.onclick = () => { activeIdx = idx; loadActiveFarmer(); renderFarmerTabs(); };
        container.insertBefore(btn, container.lastChild); 
    });
}

function toggleYP() { 
    farmers[activeIdx].use_yp = document.getElementById('use_yp').checked; 
    document.getElementById('date_yp').disabled = !farmers[activeIdx].use_yp; 
    saveToLocal(); 
    recalculate('all'); 
}

function renameFarmer() { 
    const n = prompt("New Name:", farmers[activeIdx].name); 
    if(n){ 
        farmers[activeIdx].name = n; 
        document.getElementById('prof_name').value = n;
        saveToLocal(); 
        renderFarmerTabs(); 
    } 
}

async function deleteFarmer() {
    if(farmers.length <= 1) { alert("Cannot delete the only farmer. Create another one first."); return; }
    if(confirm(`Are you sure you want to delete "${farmers[activeIdx].name}"?`)) {
        await db.farmers.delete(farmers[activeIdx].id);
        farmers.splice(activeIdx, 1);
        activeIdx = 0;
        renderFarmerTabs();
        loadActiveFarmer();
    }
}

function resetToDefault() { 
    if(confirm("Reset current farmer's manual adjustments?")){ 
        farmers[activeIdx].dates = {}; 
        farmers[activeIdx].manualKeys = []; 
        farmers[activeIdx].completed = []; 
        saveToLocal(); 
        loadActiveFarmer(); 
    } 
}

async function confirmResetAll() { 
    if(confirm("тЪая╕П CAUTION: Delete ALL farmers and data?")) { 
        await db.farmers.clear();
        localStorage.clear(); 
        location.reload(); 
    } 
}

async function shareOrDownload(blob, fileName) {
    const file = new File([blob], fileName, { type: blob.type });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try { await navigator.share({ files: [file], title: fileName }); } catch (err) { downloadFallback(blob, fileName); }
    } else { downloadFallback(blob, fileName); }
}

function downloadFallback(blob, fileName) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
}

function exportToExcel() {
    const f = farmers[activeIdx];
    const todayStr = new Date().toISOString().slice(0,10);
    const fileName = `${f.name}_${todayStr}_Schedule.csv`;
    let csv = "\uFEFF0. Field Profile\n";
    csv += `Farmer Name,${f.name}\n`;
    csv += `Village Name,${f.village || ""}\n`;
    csv += `Rice Variety,${f.variety || ""}\n`;
    csv += `Field Size,${f.fieldSize || ""} ${f.fieldSizeUnit || ""}\n`;
    csv += `GPS Coordinates,"${f.coordinates || ""}"\n\n`;
    csv += "Category,Event,Date\n";
    if(f.memos) Object.keys(f.memos).forEach(d => csv += `"Note","${f.memos[d]}","${d}"\n`);
    dateKeys.forEach(k => { if(f.dates[k.id]) csv += `"Schedule","${t(k.id)}","${f.dates[k.id]}"\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    shareOrDownload(blob, fileName);
}

function toggleComplete(id) {
    const f = farmers[activeIdx];
    if (!f.completed) f.completed = [];
    if (f.completed.includes(id)) f.completed = f.completed.filter(item => item !== id);
    else f.completed.push(id);
    saveToLocal();
    recalculate('all');
}

function renderIrrigationGraph() {
    const ctx = document.getElementById('irrigationChart');
    if (!ctx) return;
    const f = farmers[activeIdx];
    if (!f.irrigation) { if(irrigationChart) irrigationChart.destroy(); return; }
    const sortedDates = Object.keys(f.irrigation).sort();
    let cumulative = 0;
    const dailyData = [];
    const cumulativeData = [];
    sortedDates.forEach(d => {
        let val = f.irrigation[d].value;
        if (f.irrigation[d].unit === 'hr') val *= 60;
        cumulative += val;
        dailyData.push(val);
        cumulativeData.push(cumulative);
    });
    if(irrigationChart) irrigationChart.destroy();
    irrigationChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: sortedDates,
            datasets: [
                { label: 'Daily (min)', data: dailyData, backgroundColor: 'rgba(54, 162, 235, 0.6)', yAxisID: 'y' },
                { label: 'Cumulative (min)', data: cumulativeData, type: 'line', borderColor: 'rgba(255, 99, 132, 1)', yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'Daily (min)'} },
                y1: { type: 'linear', display: true, position: 'right', title: {display:true, text:'Cumulative (min)'}, grid: {drawOnChartArea: false} }
            }
        }
    });
}

function exportJSON(scope) {
    let dataToExport;
    const f = farmers[activeIdx];
    const todayStr = new Date().toISOString().slice(0,10);
    let fileName = "";
    if (scope === 'all') { dataToExport = farmers; fileName = `3F4D_FullBackup_${todayStr}.json`; }
    else { dataToExport = f; fileName = `${f.name}_${todayStr}_ShareData.json`; }
    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: "application/json" });
    shareOrDownload(blob, fileName);
}

function importJSON(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData)) {
                    if(confirm("Restore FULL Backup? This replaces ALL current data.")) {
                        await db.farmers.clear(); await db.farmers.bulkPut(importedData); location.reload();
                    }
                } else if (typeof importedData === 'object' && importedData.id) {
                    importedData.id = Date.now(); importedData.name += " (Imp)";
                    await db.farmers.put(importedData); farmers.push(importedData);
                    activeIdx = farmers.length - 1; renderFarmerTabs(); loadActiveFarmer(); alert("Import Successful!");
                } else { alert("Invalid JSON."); }
            } catch (err) { alert("Error parsing JSON."); console.error(err); }
            input.value = "";
        };
        reader.readAsText(input.files[0]);
    }
}

let currentScale = 1;
function zoomMap(delta) {
    const wrapper = document.getElementById('slide_wrapper');
    currentScale += delta;
    if (currentScale < 0.5) currentScale = 0.5;
    if (currentScale > 3.0) currentScale = 3.0;
    wrapper.style.transform = `scale(${currentScale})`;
}

function downloadMap() {
    const wrapper = document.getElementById('slide_wrapper');
    const originalTransform = wrapper.style.transform;
    const todayStr = new Date().toISOString().slice(0,10);
    wrapper.style.transform = "scale(1)";
    html2canvas(wrapper).then(canvas => {
        // PNGуБЛуВЙJPEGхУБш│к0.6уБлхдЙцЫ┤
        canvas.toBlob(blob => { shareOrDownload(blob, `Map_${farmers[activeIdx].name}_${todayStr}.jpg`); }, 'image/jpeg', 0.6);
        wrapper.style.transform = originalTransform;
    });
}

const mapContainer = document.getElementById('slide_wrapper');
let initialPinchDist = 0;
let initialPinchScale = 1;

if(mapContainer) {
    mapContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const dx = e.touches[0].pageX - e.touches[1].pageX;
            const dy = e.touches[0].pageY - e.touches[1].pageY;
            initialPinchDist = Math.sqrt(dx*dx + dy*dy);
            initialPinchScale = currentScale;
        }
    }, { passive: false });
    mapContainer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const dx = e.touches[0].pageX - e.touches[1].pageX;
            const dy = e.touches[0].pageY - e.touches[1].pageY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (initialPinchDist > 0) {
                const scaleDiff = dist / initialPinchDist;
                let newScale = initialPinchScale * scaleDiff;
                if (newScale < 0.5) newScale = 0.5;
                if (newScale > 3.0) newScale = 3.0;
                currentScale = newScale;
                mapContainer.style.transform = `scale(${currentScale})`;
            }
        }
    }, { passive: false });
}

function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const f = farmers[activeIdx];
    const todayStr = new Date().toISOString().slice(0,10);
    const slideTab = document.getElementById('tab-slide');
    const wasHidden = slideTab.classList.contains('fade') && !slideTab.classList.contains('show');
    if(wasHidden) { slideTab.classList.add('show', 'active'); slideTab.style.display = 'block'; }
    doc.setFontSize(16);
    doc.text(`3F4D Schedule: ${f.name}`, 10, 10);
    doc.setFontSize(10);
    doc.text(`Village: ${f.village || '-'} | Variety: ${f.variety || '-'} | Size: ${f.fieldSize || '-'} ${f.fieldSizeUnit || ''}`, 10, 16);
    const tableData = dateKeys.map(k => { if(!f.dates[k.id]) return null; return [t(k.id), f.dates[k.id], getBengaliDate(f.dates[k.id])]; }).filter(x => x);
    doc.autoTable({ head: [['Event', 'Date', 'Bengali Date']], body: tableData, startY: 20 });
    const wrapper = document.getElementById('slide_wrapper');
    const originalTransform = wrapper.style.transform;
    wrapper.style.transform = "scale(1)";
    // шзгхГПх║жуВТscale:1уБлф╕ЛуБТуАБJPEGх╜вх╝ПуБзхЬзч╕о
    html2canvas(wrapper, { scale: 1 }).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 0.5);
        const pdfWidth = doc.internal.pageSize.getWidth() - 20;
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        doc.addPage(); doc.text("Irrigation Map", 10, 10); doc.addImage(imgData, 'JPEG', 10, 20, pdfWidth, pdfHeight);
        const blob = doc.output('blob');
        shareOrDownload(blob, `${f.name}_${todayStr}_Report.pdf`);
        wrapper.style.transform = originalTransform;
        if(wasHidden) { slideTab.classList.remove('show', 'active'); slideTab.style.display = ''; }
    });
}

// --- Enhanced Function: Calendar Export (Compressed) ---
async function exportCalendarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const f = farmers[activeIdx];
    const todayStr = new Date().toISOString().slice(0,10);
    const originalDate = calendar.getDate();

    const allDates = [
        ...Object.values(f.dates || {}),
        ...Object.keys(f.memos || {}),
        ...Object.keys(f.photos || {}),
        ...Object.keys(f.irrigation || {})
    ].filter(d => d && d.includes('-'));

    const uniqueMonths = [...new Set(allDates.map(d => d.substring(0, 7)))].sort();

    if (uniqueMonths.length === 0) {
        alert("No scheduled events found.");
        return;
    }

    const calTab = document.getElementById('tab-cal');
    const wasHidden = !calTab.classList.contains('show');
    if(wasHidden) { calTab.classList.add('show', 'active'); calTab.style.display = 'block'; }
    
    for (let i = 0; i < uniqueMonths.length; i++) {
        const monthStr = uniqueMonths[i];
        calendar.gotoDate(monthStr + "-01");
        calendar.updateSize();
        await new Promise(r => setTimeout(r, 600));

        const calEl = document.getElementById('calendar');
        // scale: 1 уБлф╕ЛуБТуБжш╗╜щЗПхМЦ
        await html2canvas(calEl, { scale: 2 }).then(canvas => {
            if (i > 0) doc.addPage();
            doc.setFontSize(14);
            doc.text(`${f.name} - ${monthStr}`, 10, 12);
            doc.setFontSize(9);
            const profileText = `Village: ${f.village || '-'} | Variety: ${f.variety || '-'} | Size: ${f.fieldSize || '-'} ${f.fieldSizeUnit || ''} | GPS: ${f.coordinates || '-'}`;
            doc.text(profileText, 10, 18);

            // PNGуБЛуВЙJPEGуБлхдЙцЫ┤уБЧуАБхУБш│куВТ0.8уБлшинхоЪ
            const imgData = canvas.toDataURL('image/jpeg', 0.8);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            const displayWidth = pdfWidth - (margin * 2);
            const displayHeight = (canvas.height * displayWidth) / canvas.width;

            doc.addImage(imgData, 'JPEG', margin, 22, displayWidth, displayHeight);
        });
    }

    calendar.gotoDate(originalDate);
    if(wasHidden) { calTab.classList.remove('show', 'active'); calTab.style.display = ''; }

    const blob = doc.output('blob');
    shareOrDownload(blob, `${f.name}_${todayStr}_FullCalendar.pdf`);
}

function exportIrrigationCSV() {
    const f = farmers[activeIdx];
    const todayStr = new Date().toISOString().slice(0,10);
    const fileName = `${f.name}_${todayStr}_IrrigationTime.csv`;
    if (!f.irrigation) return alert("No irrigation data.");
    let csv = "\uFEFF0. Field Profile\n";
    csv += `Farmer Name,${f.name}\nVillage Name,${f.village || ""}\nRice Variety,${f.variety || ""}\nField Size,${f.fieldSize || ""} ${f.fieldSizeUnit || ""}\nGPS Coordinates,"${f.coordinates || ""}"\n\nDate,Value,Unit\n`;
    Object.keys(f.irrigation).sort().forEach(d => { csv += `${d},${f.irrigation[d].value},${f.irrigation[d].unit}\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    shareOrDownload(blob, fileName);
}

function exportIrrigationPDF() {
    if(!irrigationChart) return alert("No chart available.");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    const f = farmers[activeIdx];
    const todayStr = new Date().toISOString().slice(0,10);
    doc.setFontSize(16); doc.text(`Irrigation Graph: ${f.name}`, 10, 10);
    // уВ░уГйуГХчФ╗хГПуВВхЬзч╕ошинхоЪуБзхПЦх╛Ч
    const imgData = irrigationChart.toBase64Image('image/jpeg', 0.6); 
    doc.addImage(imgData, 'JPEG', 10, 20, 280, 150);
    const blob = doc.output('blob');
    shareOrDownload(blob, `${f.name}_${todayStr}_IrrigationGraph.pdf`);
}

function checkNotifications() {
    if (!("Notification" in window)) return;
    if (Notification.permission !== "granted") { Notification.requestPermission(); }
    else {
        const f = farmers[activeIdx];
        if(!f) return;
        const today = new Date();
        const todayStr = formatDateISO(today);
        const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowStr = formatDateISO(tomorrow);
        dateKeys.forEach(k => {
            if(f.dates[k.id] === todayStr) {
                const eventLabel = t(k.id);
                const msg = currentLang === 'bn' ? `ржЖржЬ ${eventLabel}` : `Today is ${eventLabel}`;
                new Notification("3F4D Notification", { body: msg, icon: 'icon.png' }); alert(msg);
            }
        });
        let eventFound = false;
        dateKeys.forEach(k => { if(f.dates[k.id] === tomorrowStr) eventFound = true; });
        if(eventFound) new Notification(t('notif_title'), { body: t('notif_msg'), icon: 'icon.png' });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    changeLanguage(localStorage.getItem('f3d_lang') || 'en');
    memoModal = new bootstrap.Modal(document.getElementById('memoModal'));
    initApp(); 
    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), { 
        initialView: 'dayGridMonth', 
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
        height: 'auto', 
        dateClick: handleDateClick,
        dayCellContent: function(arg) {
            const gregDay = arg.date.getDate();
            const benDateStr = getBengaliDate(formatDateISO(arg.date), true);
            return { html: `${gregDay}<br><span class="ben-cal-date">${benDateStr}</span>` };
        }
    });
    calendar.render(); 
    document.getElementById('cal-tab').addEventListener('shown.bs.tab', () => { if (calendar) { calendar.updateSize(); calendar.render(); } });
    document.querySelectorAll('.config-panel input[type="number"]').forEach(el => { if(!el.id.startsWith('prof_')) el.onchange = () => recalculate('all'); });
});
</script>

<footer class="text-center mt-5 mb-4 text-secondary" style="font-size: 0.75rem; border-top: 1px solid #dee2e6; padding-top: 20px;">
<p class="mb-1">This app was developed by Takehiro Kamiya (Univ. Tokyo).</p>
<p class="mb-0">Use this application at your own risk.</p>
</footer>

</body>
</html>